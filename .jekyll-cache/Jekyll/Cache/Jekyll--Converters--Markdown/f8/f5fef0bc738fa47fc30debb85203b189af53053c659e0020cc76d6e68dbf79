I"ÎD<h2 id="recall-big-step-pros--cons">Recall Big-step Pros &amp; Cons</h2>

<h2 id="big-step">Big-step</h2>

<blockquote>
  <p>ä¸€æ­¥åˆ°ä½ :  <em>eval to its final value (plus final store)</em></p>
</blockquote>

<h3 id="pros---natural-so-called-natural-semantics-all-in-one-big-step">Pros - natural (so called <em>natural semantics</em>), â€œall in one big stepâ€</h3>

<h3 id="cons---not-catch-the-essence-of-how-program-behave">Cons - not catch the <em>essence of how program behave</em></h3>

<blockquote>
  <p>å¤§æ­¥è¯­ä¹‰åªæ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">ç¨‹åº â†¦ ç»“æœ</code> è¿™æ ·çš„ pair é›†åˆï¼Œè€Œã€Œå¦‚ä½•ä¸€æ­¥æ­¥å¤„ç†ã€æ‰æ˜¯ç¨‹åºã€Œæ‰§è¡Œã€çš„æœ¬è´¨</p>
</blockquote>

<p>not just input state get mapped to output state.
but also <em>intermediate state</em> (which could be observed by <em>concurrent</em> code!)</p>

<h3 id="cons---not-technically-expressive-enough-to-express-exception--crash--non-termination">Cons - not technically expressive enough to express <em>exception / crash / non-termination</em></h3>

<blockquote>
  <p>æ¯”å¦‚è¯´ï¼Œå¤§æ­¥è¯­ä¹‰æ— æ³•åŒºåˆ†ã€Œä¸åœæœºã€ä¸ã€Œå¡ä½ã€
two quite different reasons of â€œfail to map a given state to any ending stateâ€</p>
</blockquote>

<ol>
  <li>ä¸åœæœº nontermination - we want to allow this (infinite loop is the price paid for usability)</li>
  <li>å¡ä½ getting stuck / undefiend behaviour æœªå®šä¹‰è¡Œä¸º  - we want to prevent (wrong)</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">WHILE_true_nonterm</code> ä»…ä»…è¡¨è¾¾äº†ã€Œç¨‹åºä¸èƒ½å† take stepã€ï¼Œæ— æ³•ä¸ã€Œå¡ä½ã€åŒºåˆ†</li>
  <li><code class="language-plaintext highlighter-rouge">WHILE_true</code> æ›´æ˜¯ç›´æ¥è®©ä»»ä½•ã€Œæ— é™å¾ªç¯ã€çš„ç¨‹åºéƒ½ã€Œç­‰ä»·ã€äº†â€¦è€Œå¿½ç•¥äº†ä¸­é—´çŠ¶æ€å’Œ effect (ä½œç”¨)</li>
</ul>

<blockquote>
  <p>we need <em>a way of presenting semantics that distinguish</em> nontermination from erroneous â€œstuck statesâ€</p>
</blockquote>

<h2 id="small-step">Small-step</h2>

<blockquote>
  <p>æ›´ç²¾ç»†åŒ– :  a <em>finer-grained</em> way of defining and reasoning about program behaviors. 
åŸå­æ­¥éª¤ :  <em>â€œatomic stepsâ€</em> of computation are performed.</p>
</blockquote>

<h2 id="a-toy-language">A Toy Language</h2>

<p>Only Constant and Plus</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">nat</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="c">(* Constant *)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">tm</span><span class="pi">.</span><span class="w"> </span><span class="c">(* Plus *)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="big-step-1">Big-Step</h3>

<p><code class="language-plaintext highlighter-rouge">==&gt;</code> is really <code class="language-plaintext highlighter-rouge">â‡“</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>            ---------        (E_Const)
            C n ==&gt; n

            t1 ==&gt; n1
            t2 ==&gt; n2
        -------------------  (E_Plus)
        P t1 t2 ==&gt; n1 + n2
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="small-step-1">Small-Step</h3>

<blockquote>
  <p>single reduction step
find leftmost redex</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>  -------------------------------   (ST_PlusConstConst)
  P (C n1) (C n2) --&gt; C (n1 + n2)

          t1 --&gt; t1'
      --------------------          (ST_Plus1)
      P t1 t2 --&gt; P t1' t2

          t2 --&gt; t2'
  ----------------------------      (ST_Plus2)
  P (C n1) t2 --&gt; P (C n1) t2'
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="relations">Relations</h2>

<blockquote>
  <p>Check notes of <code class="language-plaintext highlighter-rouge">rel</code> and <code class="language-plaintext highlighter-rouge">tactics</code> for more details about bi-relation.</p>
</blockquote>

<h3 id="deterministic-ç¡®å®šæ€§">Deterministic ç¡®å®šæ€§</h3>

<blockquote>
  <p>a.k.a Partial Function. 
in terms of its <em>right uniqueness</em> under mathematical context, not its emphasise on <em>partial</em> under programming context)</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Definition</span><span class="w"> </span><span class="no">deterministic</span><span class="w"> </span><span class="o">{</span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="p">âˆ€</span><span class="no">x</span><span class="w"> </span><span class="no">y1</span><span class="w"> </span><span class="no">y2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">X</span><span class="o">,</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y1</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y2</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">y2</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">deterministic step</code> can be proved by induction on derivation <code class="language-plaintext highlighter-rouge">x --&gt; y1</code></p>
<ul>
  <li>use <code class="language-plaintext highlighter-rouge">generalize dependent y2</code>!</li>
  <li>in informal proof, we usually just take <code class="language-plaintext highlighter-rouge">âˆ€ y2</code> by default.</li>
</ul>

<h3 id="ltac-solve_by_inverts-n"><code class="language-plaintext highlighter-rouge">Ltac solve_by_inverts n</code></h3>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">Ltac</span><span class="w"> </span><span class="no">solve_by_inverts</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">goal</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">H</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">?T</span><span class="w"> </span><span class="p">âŠ¢</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
    </span><span class="ne">solve</span><span class="w"> </span><span class="o">[</span><span class="w">
      </span><span class="kp">inversion</span><span class="w"> </span><span class="no">H</span><span class="p">;</span><span class="w">
      </span><span class="kr">match</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="no">S</span><span class="w"> </span><span class="o">(</span><span class="no">S</span><span class="w"> </span><span class="o">(</span><span class="nv">?n'</span><span class="o">))</span><span class="w"> </span><span class="p">â‡’</span><span class="w"> </span><span class="kp">subst</span><span class="p">;</span><span class="w"> </span><span class="no">solve_by_inverts</span><span class="w"> </span><span class="o">(</span><span class="no">S</span><span class="w"> </span><span class="no">n'</span><span class="o">)</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="o">]</span><span class="w">
  </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="values-å€¼">Values å€¼</h3>

<h4 id="abstract-machine-æŠ½è±¡æœº">Abstract Machine æŠ½è±¡æœº!</h4>

<blockquote>
  <p>think of the <code class="language-plaintext highlighter-rouge">--&gt;</code> relation as defining an <em>abstract machine</em>:</p>
</blockquote>

<ul>
  <li>term = <em>state</em> of machine é¡¹ = æœºå™¨çŠ¶æ€</li>
  <li>step = atomic unit of computation (think as assembly opcode / CPU instructrion)</li>
  <li><em>halting state</em> = no more computation. åœæœºçŠ¶æ€</li>
</ul>

<blockquote>
  <p>execute a term <code class="language-plaintext highlighter-rouge">t</code>:</p>
</blockquote>

<ul>
  <li>starting state = <code class="language-plaintext highlighter-rouge">t</code></li>
  <li>repeatedly use <code class="language-plaintext highlighter-rouge">--&gt;</code></li>
  <li>when halt, <em>read out</em> the <em>final state</em> as result of execution</li>
</ul>

<blockquote>
  <p>Intutively, we call such (final state) terms <em>values</em>.
Okay so the point isâ€¦this language is simple enough (no stuck state).
and in this lang, value can only be <code class="language-plaintext highlighter-rouge">C</code>onst:</p>
</blockquote>

<blockquote>
  <p>åœ¨è¿™ä¸ªè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬ã€Œè§„å®šã€åªæœ‰ <code class="language-plaintext highlighter-rouge">C</code>onst æ˜¯ã€Œå€¼ã€:</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">v_const</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">n</span><span class="o">,</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="no">n</span><span class="o">).</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>and we can write <code class="language-plaintext highlighter-rouge">ST_Plus2</code> more elegant:
wellâ€¦in this lang, not really, since only one form of value to write out.
in cases we have multiple form of value, by doing this we donâ€™t have to write out any cases.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>         value v1
        t2 --&gt; t2'
    --------------------  (ST_Plus2)
    P v1 t2 --&gt; P v1 t2'
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="strong-progress-and-normal-forms-å¼ºå¯è¿›æ€§å’Œæ­£è§„å¼">Strong Progress and Normal Forms å¼ºå¯è¿›æ€§å’Œæ­£è§„å¼</h3>

<blockquote>
  <p><em>strong progress</em>: every term either is a value or can â€œmake progressâ€</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">strong_progress</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t</span><span class="o">,</span><span class="w">
  </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">âˆ¨</span><span class="w"> </span><span class="o">(</span><span class="p">âˆƒ</span><span class="no">t'</span><span class="o">,</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">t'</span><span class="o">).</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>terms that cannot make progress.
for an arbitrary relation <code class="language-plaintext highlighter-rouge">R</code> over an arbitrary set <code class="language-plaintext highlighter-rouge">X</code></p>
</blockquote>

<blockquote>
  <p><em>normal form</em>: term that cannot make progress (take a step)
å…¶å®æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢ç†è§£ä¸ºã€Œå¸¸æ€ã€æˆ–ã€Œæ— èƒ½é‡ç¨³å®šæ€ã€</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Definition</span><span class="w"> </span><span class="no">normal_form</span><span class="w"> </span><span class="o">{</span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="p">Â¬âˆƒ</span><span class="no">t'</span><span class="o">,</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>theorem: <em>in this language</em>, normal forms and values are actually the same thing.</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">Lemma</span><span class="w"> </span><span class="no">value_is_nf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">normal_form</span><span class="w"> </span><span class="no">step</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span><span class="k">Lemma</span><span class="w"> </span><span class="no">nf_is_value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">normal_form</span><span class="w"> </span><span class="no">step</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="pi">.</span><span class="w">
</span><span class="k">Corollary</span><span class="w"> </span><span class="no">nf_same_as_value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">normal_form</span><span class="w"> </span><span class="no">step</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">â†”</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="value--normal-form-not-always">Value != Normal Form (not always)</h4>

<blockquote>
  <p>value       is a <em>syntactic</em> concept : it is defined by looking at the form of a term 
normal form is a <em>semantic</em>  one     : it is defined by looking at how the term steps.</p>
</blockquote>

<blockquote>
  <p>E.g. we can defined term that can take a step as â€œvalueâ€:
æ·»åŠ ä¸€ä¸ªä¸æ˜¯ normal form çš„ value</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">v_const</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">n</span><span class="o">,</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="no">n</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">v_funny</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t1</span><span class="w"> </span><span class="no">n2</span><span class="o">,</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="no">n2</span><span class="o">)).</span><span class="w"> </span><span class="c">(* &lt;--- it can actually progress! *)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>æˆ–è€…æ›´æ”¹ <code class="language-plaintext highlighter-rouge">step</code> è®© value ä¸æ˜¯ normal formâ€¦</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">step</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">ST_Funny</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">n</span><span class="o">,</span><span class="w">   
      </span><span class="no">C</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="no">n</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w">                </span><span class="c">(* &lt;--- or a weird  *)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="multi-step-reduction----å¤šæ­¥è§„çº¦">Multi-Step Reduction <code class="language-plaintext highlighter-rouge">--&gt;*</code> å¤šæ­¥è§„çº¦</h2>

<blockquote>
  <p>relation <code class="language-plaintext highlighter-rouge">multi R</code>: <em>multi-step closure of R</em> 
same as <code class="language-plaintext highlighter-rouge">clos_refl_trans_1n</code> in <code class="language-plaintext highlighter-rouge">Rel</code> chapter.</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">multi</span><span class="w"> </span><span class="o">{</span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">multi_refl</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">X</span><span class="o">),</span><span class="w"> </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">x</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">multi_step</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="no">z</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">X</span><span class="o">),</span><span class="w">
                    </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="p">â†’</span><span class="w">
                    </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="no">z</span><span class="w"> </span><span class="p">â†’</span><span class="w">
                    </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">z</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šæ˜¯ä¸€ç§æ–¹ä¾¿çš„å®šä¹‰ï¼Œè€Œä»¥ä¸‹åˆ™ç»™äº†æˆ‘ä»¬ä¸¤ä¸ª helper å®šç†ï¼š</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">multi_R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="o">(</span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">X</span><span class="o">),</span><span class="w">
    </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="p">â†’</span><span class="w"> 
    </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="pi">.</span><span class="w">

</span><span class="k">Theorem</span><span class="w"> </span><span class="no">multi_trans</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="o">(</span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="no">z</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">X</span><span class="o">),</span><span class="w">
    </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="p">â†’</span><span class="w">
    </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="no">z</span><span class="w"> </span><span class="p">â†’</span><span class="w">
    </span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">z</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="normal-forms-again">Normal Forms Again</h3>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">Definition</span><span class="w"> </span><span class="no">step_normal_form</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">normal_form</span><span class="w"> </span><span class="no">step</span><span class="pi">.</span><span class="w">  </span><span class="c">(** è¿™ä¸ªæ˜¯ä¸€ä¸ªã€Œæ€§è´¨ã€ Property : _ -&gt; Prop , ä» polymorphic çš„ [normal_form] ä»¥ [step] å®ä¾‹åŒ–è€Œæ¥ **)</span><span class="w"> 
</span><span class="k">Definition</span><span class="w"> </span><span class="no">normal_form_of</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">          </span><span class="c">(** æ˜¯ä¸¤ä¸ªé¡¹ä¹‹é—´çš„ï¼ˆi.e. å®šä¹‰åœ¨ [tm] é›†åˆä¸Šçš„) äºŒå…ƒå…³ç³», å³ t' æ˜¯ t çš„æ­£è§„å¼ **)</span><span class="w">
  </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">âˆ§</span><span class="w"> </span><span class="no">step_normal_form</span><span class="w"> </span><span class="no">t'</span><span class="o">).</span><span class="w">
  
</span><span class="k">Theorem</span><span class="w"> </span><span class="no">normal_forms_unique</span><span class="p">:</span><span class="w">                      </span><span class="c">(** single-step reduction is deterministic å¯ä»¥æ¨å‡º normal form is unique for a given term **)</span><span class="w">
  </span><span class="no">deterministic</span><span class="w"> </span><span class="no">normal_form_of</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="normalizing-æ€»æ˜¯å¯æ­£è§„åŒ–å¾—---evaluating-to-completion">Normalizing æ€»æ˜¯å¯æ­£è§„åŒ–å¾—  â€“ â€œEvaluating to completionâ€</h3>

<blockquote>
  <p>something stronger is true for this language (though not for all languages)
reduction of <em>any</em> term <code class="language-plaintext highlighter-rouge">t</code> will eventually reach a normal form (æˆ‘ä»¬çŸ¥é“ STLC ä¹Ÿæœ‰è¿™ä¸ªç‰¹æ€§)</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">Definition</span><span class="w"> </span><span class="no">normalizing</span><span class="w"> </span><span class="o">{</span><span class="no">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">relation</span><span class="w"> </span><span class="no">X</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="p">âˆ€</span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="p">âˆƒ</span><span class="no">t'</span><span class="o">,</span><span class="w">
    </span><span class="o">(</span><span class="no">multi</span><span class="w"> </span><span class="no">R</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">âˆ§</span><span class="w"> </span><span class="no">normal_form</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">t'</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>To prove this, we need lemma showing some <em>congruence</em> of <code class="language-plaintext highlighter-rouge">--&gt;*</code>: 
åŒä½™å…³ç³»ï¼Œä¸è¿‡è¿™æ¬¡æ˜¯å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">--&gt;*</code> è¿™ä¸ªå…³ç³»ä¸Šï¼Œagainï¼ŒåŒä½™æŒ‡çš„æ˜¯ã€Œå…³ç³»å¯¹äºç»“æ„ä¸Šçš„æ“ä½œä¿æŒã€</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">Lemma</span><span class="w"> </span><span class="no">multistep_congr_1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t1</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="no">t2</span><span class="o">,</span><span class="w">
     </span><span class="no">t1</span><span class="w"> </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="p">â†’</span><span class="w"> 
     </span><span class="no">P</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="no">t2</span><span class="pi">.</span><span class="w">

</span><span class="k">Lemma</span><span class="w"> </span><span class="no">multistep_congr_2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="no">t2'</span><span class="o">,</span><span class="w">
     </span><span class="no">value</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="p">â†’</span><span class="w">
     </span><span class="no">t2</span><span class="w"> </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">t2'</span><span class="w"> </span><span class="p">â†’</span><span class="w">
     </span><span class="no">P</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2'</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Then we can proveâ€¦</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">step_normalizing</span><span class="w"> </span><span class="p">:</span><span class="w">
  </span><span class="no">normalizing</span><span class="w"> </span><span class="no">step</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="equivalence-of-big-step-and-small-step">Equivalence of Big-Step and Small-Step</h3>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">eval__multistep</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t</span><span class="w"> </span><span class="no">n</span><span class="o">,</span><span class="w">
  </span><span class="no">t</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="no">n</span><span class="pi">.</span><span class="w">

</span><span class="k">Theorem</span><span class="w"> </span><span class="no">multistep__eval</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="o">,</span><span class="w">
  </span><span class="no">normal_form_of</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="p">âˆƒ</span><span class="no">n</span><span class="o">,</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="p">âˆ§</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="no">n</span><span class="pi">.</span><span class="w">    </span><span class="c">(* might be better to say value here? *)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="additional-combined-language">Additional: Combined Language</h2>

<p>What if we combined the lang <code class="language-plaintext highlighter-rouge">Arith</code> and lang <code class="language-plaintext highlighter-rouge">Boolean</code>?
Would <code class="language-plaintext highlighter-rouge">step_deterministic</code> and <code class="language-plaintext highlighter-rouge">strong_progress</code> still holds?</p>

<p>Intuition:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">step_deterministic</code> should still hold</li>
  <li>but <code class="language-plaintext highlighter-rouge">strong_progress</code> would definitely not!!
    <ul>
      <li>now we mixed two <em>types</em> so we will have stuck terms e.g. <code class="language-plaintext highlighter-rouge">test 5</code> or <code class="language-plaintext highlighter-rouge">tru + 4</code>.</li>
      <li>we will need type check and then we would be able to prove <code class="language-plaintext highlighter-rouge">progress</code> (which require well-typeness)</li>
    </ul>
  </li>
</ul>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">strong_progress</span><span class="w"> </span><span class="p">:</span><span class="w">
  </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">\/</span><span class="w"> </span><span class="o">(</span><span class="kp">exists</span><span class="w"> </span><span class="no">t'</span><span class="o">,</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">t'</span><span class="o">))</span><span class="w"> </span><span class="o">\/</span><span class="w">
  </span><span class="o">~</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">\/</span><span class="w"> </span><span class="o">(</span><span class="kp">exists</span><span class="w"> </span><span class="no">t'</span><span class="o">,</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">t'</span><span class="o">)).</span><span class="w">
</span><span class="k">Proof</span><span class="pi">.</span><span class="w">
  </span><span class="no">right</span><span class="pi">.</span><span class="w"> </span><span class="kp">intros</span><span class="w"> </span><span class="no">Hcontra</span><span class="pi">.</span><span class="w">
  </span><span class="no">remember</span><span class="w"> </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="no">tru</span><span class="w"> </span><span class="no">fls</span><span class="o">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="no">stuck</span><span class="pi">.</span><span class="w">   </span><span class="c">(** ç±»ä¼¼ disprove equiv = ä¸¾ä¸€ä¸ªåä¾‹å°±å¥½ **)</span><span class="w">
  </span><span class="kp">specialize</span><span class="w"> </span><span class="o">(</span><span class="no">Hcontra</span><span class="w"> </span><span class="no">stuck</span><span class="o">).</span><span class="w">
  </span><span class="kp">destruct</span><span class="w"> </span><span class="no">Hcontra</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="o">[</span><span class="no">Hcvalue</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Hcprogress</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="kp">subst</span><span class="pi">.</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="kp">inversion</span><span class="w"> </span><span class="no">Hcvalue</span><span class="p">;</span><span class="w"> </span><span class="kp">inversion</span><span class="w"> </span><span class="no">H</span><span class="pi">.</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="kp">destruct</span><span class="w"> </span><span class="no">Hcprogress</span><span class="pi">.</span><span class="w"> </span><span class="kp">inversion</span><span class="w"> </span><span class="no">H</span><span class="pi">.</span><span class="w"> </span><span class="kp">inversion</span><span class="w"> </span><span class="no">H3</span><span class="pi">.</span><span class="w"> </span><span class="kp">inversion</span><span class="w"> </span><span class="no">H4</span><span class="pi">.</span><span class="w">
</span><span class="k">Qed</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="small-step-imp">Small-Step IMP</h2>

<p>åˆåˆ°äº†è€æœ‹å‹ IMPâ€¦â€¦è¿˜å¥½æ²¡ç»ƒä¹ â€¦â€¦ç®€å•çœ‹ä¸€ä¸‹</p>

<p>é¦–å…ˆå¯¹äºå®šä¹‰å°æ­¥è¯­ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ <code class="language-plaintext highlighter-rouge">value</code> å’Œ <code class="language-plaintext highlighter-rouge">--&gt;</code> (step)</p>

<h3 id="aexp-bexp"><code class="language-plaintext highlighter-rouge">aexp</code>, <code class="language-plaintext highlighter-rouge">bexp</code></h3>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">aval</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">aexp</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">av_num</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">n</span><span class="o">,</span><span class="w"> </span><span class="no">aval</span><span class="w"> </span><span class="o">(</span><span class="no">ANum</span><span class="w"> </span><span class="no">n</span><span class="o">).</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">bexp</code> ä¸éœ€è¦ <code class="language-plaintext highlighter-rouge">value</code> å› ä¸ºåœ¨è¿™ä¸ªè¯­è¨€é‡Œ <code class="language-plaintext highlighter-rouge">BTrue</code> å’Œ <code class="language-plaintext highlighter-rouge">BFalse</code> çš„ step æ€»æ˜¯ disjointed å¾—ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ä»»ä½•å¤ç”¨ <code class="language-plaintext highlighter-rouge">value</code> predicate çš„æ—¶å€™</p>

<h3 id="--a---b"><code class="language-plaintext highlighter-rouge">--&gt;a</code>, <code class="language-plaintext highlighter-rouge">--&gt;b</code></h3>

<p>è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆä¸º <code class="language-plaintext highlighter-rouge">aexp</code>, <code class="language-plaintext highlighter-rouge">bexp</code> å®šä¹‰äº†å®ƒä»¬å„è‡ªçš„å°æ­¥è¯­ä¹‰ï¼Œ</p>

<blockquote>
  <p>ä½†æ˜¯ï¼Œå…¶å® from PLT we know, æˆ‘ä»¬å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥å¤ç”¨ <code class="language-plaintext highlighter-rouge">aexp</code>, <code class="language-plaintext highlighter-rouge">bexp</code> çš„å¤§æ­¥è¯­ä¹‰ï¼</p>
  <ol>
    <li>å¤§æ­¥è¯­ä¹‰è¦çŸ­å¾—å¤š</li>
    <li><code class="language-plaintext highlighter-rouge">aexp</code>, <code class="language-plaintext highlighter-rouge">bexp</code> å…¶å®å¹¶ä¸ä¼šå‡º
      <ul>
        <li>ã€Œä¸åœæœºã€: æ²¡æœ‰ jump ç­‰æ§åˆ¶æµç»“æ„</li>
        <li>ã€Œå¼‚å¸¸ã€/ã€Œå¡ä½ã€: æˆ‘ä»¬åœ¨ meta-language çš„ AST é‡Œå°±åŒºåˆ†äº† <code class="language-plaintext highlighter-rouge">aexp</code> å’Œ <code class="language-plaintext highlighter-rouge">bexp</code>ï¼Œç›¸å½“äºä¸»åŠ¨çº¦æŸäº†ç±»å‹ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç° <code class="language-plaintext highlighter-rouge">5 || 3</code> è¿™æ · type error çš„ AST</li>
      </ul>
    </li>
  </ol>
</blockquote>

<h3 id="cmd---"><code class="language-plaintext highlighter-rouge">cmd</code>, <code class="language-plaintext highlighter-rouge">--&gt;</code></h3>

<blockquote>
  <p>æˆ‘ä»¬æŠŠ <code class="language-plaintext highlighter-rouge">SKIP</code> å½“ä½œä¸€ä¸ªã€Œå‘½ä»¤å€¼ï¼ˆcommand valueï¼‰ã€ i.e. ä¸€ä¸ªå·²ç»åˆ°è¾¾ normal form çš„å‘½ä»¤ã€‚</p>
  <ul>
    <li>èµ‹å€¼å‘½ä»¤å½’çº¦åˆ° <code class="language-plaintext highlighter-rouge">SKIP</code> ï¼ˆå’Œä¸€ä¸ªæ–°çš„ stateï¼‰ã€‚</li>
    <li>é¡ºåºå‘½ä»¤ç­‰å¾…å…¶å·¦ä¾§å­å‘½ä»¤å½’çº¦åˆ° <code class="language-plaintext highlighter-rouge">SKIP</code>ï¼Œç„¶åä¸¢å¼ƒå®ƒï¼Œå¹¶ç»§ç»­å¯¹å³ä¾§å­å‘½ä»¤å½’çº¦ã€‚</li>
  </ul>
</blockquote>

<blockquote>
  <p>å¯¹ <code class="language-plaintext highlighter-rouge">WHILE</code> å‘½ä»¤çš„å½’çº¦æ˜¯æŠŠ <code class="language-plaintext highlighter-rouge">WHILE</code> å‘½ä»¤å˜æ¢ä¸ºæ¡ä»¶è¯­å¥ï¼Œå…¶åç´§è·ŸåŒä¸€ä¸ª <code class="language-plaintext highlighter-rouge">WHILE</code> å‘½ä»¤ã€‚</p>
</blockquote>

<blockquote>
  <p>è¿™äº›éƒ½ä¸ PLT æ˜¯ä¸€è‡´çš„</p>
</blockquote>

<h2 id="concurrent-imp">Concurrent IMP</h2>

<p>ä¸ºäº†å±•ç¤º å°æ­¥è¯­ä¹‰ çš„èƒ½åŠ›ï¼Œletâ€™s enrich IMP with concurrency.</p>
<ul>
  <li>unpredictable scheduling (subcommands may be <em>interleaved</em>)</li>
  <li><em>share same memory</em></li>
</ul>

<p>Itâ€™s slightly confusing here to use <code class="language-plaintext highlighter-rouge">Par</code> (meaning <em>in parallel</em>) 
I mean, concurrency <em>could</em> be in parallel but it doesnâ€™t have toâ€¦</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">com</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">CPar</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">com</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">com</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">com</span><span class="pi">.</span><span class="w"> </span><span class="c">(* &lt;--- NEW *)</span><span class="w">

</span><span class="k">Inductive</span><span class="w"> </span><span class="no">cstep</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">(</span><span class="no">com</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">state</span><span class="o">)</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="o">(</span><span class="no">com</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">state</span><span class="o">)</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="c">(* New part: *)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">CS_Par1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">st</span><span class="w"> </span><span class="no">c1</span><span class="w"> </span><span class="no">c1'</span><span class="w"> </span><span class="no">c2</span><span class="w"> </span><span class="no">st'</span><span class="o">,</span><span class="w">
      </span><span class="no">c1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">c1'</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st'</span><span class="w"> </span><span class="p">â†’</span><span class="w">
      </span><span class="o">(</span><span class="no">PAR</span><span class="w"> </span><span class="no">c1</span><span class="w"> </span><span class="no">WITH</span><span class="w"> </span><span class="no">c2</span><span class="w"> </span><span class="no">END</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">PAR</span><span class="w"> </span><span class="no">c1'</span><span class="w"> </span><span class="no">WITH</span><span class="w"> </span><span class="no">c2</span><span class="w"> </span><span class="no">END</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st'</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">CS_Par2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">st</span><span class="w"> </span><span class="no">c1</span><span class="w"> </span><span class="no">c2</span><span class="w"> </span><span class="no">c2'</span><span class="w"> </span><span class="no">st'</span><span class="o">,</span><span class="w">
      </span><span class="no">c2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">c2'</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st'</span><span class="w"> </span><span class="p">â†’</span><span class="w">
      </span><span class="o">(</span><span class="no">PAR</span><span class="w"> </span><span class="no">c1</span><span class="w"> </span><span class="no">WITH</span><span class="w"> </span><span class="no">c2</span><span class="w"> </span><span class="no">END</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">PAR</span><span class="w"> </span><span class="no">c1</span><span class="w"> </span><span class="no">WITH</span><span class="w"> </span><span class="no">c2'</span><span class="w"> </span><span class="no">END</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st'</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">CS_ParDone</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">st</span><span class="o">,</span><span class="w">
      </span><span class="o">(</span><span class="no">PAR</span><span class="w"> </span><span class="no">SKIP</span><span class="w"> </span><span class="no">WITH</span><span class="w"> </span><span class="no">SKIP</span><span class="w"> </span><span class="no">END</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">SKIP</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">st</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="a-small-step-stack-machine--å°æ­¥æ ˆæœº">A Small-Step Stack Machine  å°æ­¥æ ˆæœº</h2>

<p>å•Šå“ˆï¼IMP ç« èŠ‚ Stack Machineï¼Œæˆ‘ä»¬ä¹‹å‰ä»…ä»…å®šä¹‰äº† <code class="language-plaintext highlighter-rouge">Fixpoint s_execute</code> å’Œ <code class="language-plaintext highlighter-rouge">Fixpoint s_compile</code>ï¼Œè¿™é‡Œç»™å‡ºå…¶å°æ­¥è¯­ä¹‰</p>
<blockquote>
  <p>å¯¹äºæœ¬èº«å°±ä¸ã€Œå°æ­¥è¯­ä¹‰ã€åœ¨ç²¾ç¥ä¸Šæ›´ç»Ÿä¸€çš„ã€ŒæŠ½è±¡æœºã€ï¼Œæˆ‘æ€€ç–‘å…¶è¯­ä¹‰éƒ½åº”è¯¥æ˜¯è¶³å¤Ÿã€Œå°ã€çš„ï¼ˆå³å¤§å°æ­¥å°†æ˜¯ä¸€è‡´çš„ï¼Ÿ)</p>
</blockquote>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">Definition</span><span class="w"> </span><span class="no">stack</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">nat</span><span class="pi">.</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">prog</span><span class="w">  </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">sinstr</span><span class="pi">.</span><span class="w">

</span><span class="k">Inductive</span><span class="w"> </span><span class="no">stack_step</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">prog</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">stack</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">prog</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">stack</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">SS_Push</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">stk</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w">
    </span><span class="no">stack_step</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">(</span><span class="no">SPush</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">stk</span><span class="o">)</span><span class="w">      </span><span class="o">(</span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">stk</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">SS_Load</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">stk</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w">
    </span><span class="no">stack_step</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">(</span><span class="no">SLoad</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">stk</span><span class="o">)</span><span class="w">      </span><span class="o">(</span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">stk</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">SS_Plus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">stk</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">m</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w">
    </span><span class="no">stack_step</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">(</span><span class="no">SPlus</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">n</span><span class="p">::</span><span class="no">m</span><span class="p">::</span><span class="no">stk</span><span class="o">)</span><span class="w">  </span><span class="o">(</span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">m</span><span class="o">+</span><span class="no">n</span><span class="o">)</span><span class="p">::</span><span class="no">stk</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">SS_Minus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">stk</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">m</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w">
    </span><span class="no">stack_step</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">(</span><span class="no">SMinus</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">n</span><span class="p">::</span><span class="no">m</span><span class="p">::</span><span class="no">stk</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">m</span><span class="o">-</span><span class="no">n</span><span class="o">)</span><span class="p">::</span><span class="no">stk</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">SS_Mult</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">stk</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">m</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w">
    </span><span class="no">stack_step</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">(</span><span class="no">SMult</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="no">n</span><span class="p">::</span><span class="no">m</span><span class="p">::</span><span class="no">stk</span><span class="o">)</span><span class="w">  </span><span class="o">(</span><span class="no">p'</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">m</span><span class="o">*</span><span class="no">n</span><span class="o">)</span><span class="p">::</span><span class="no">stk</span><span class="o">).</span><span class="w">
    
</span><span class="c">(** closure of stack_step **)</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">stack_multistep</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">multi</span><span class="w"> </span><span class="o">(</span><span class="no">stack_step</span><span class="w"> </span><span class="no">st</span><span class="o">).</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="compiler-correctness">Compiler Correctness</h3>

<blockquote>
  <p>ã€Œç¼–è¯‘å™¨çš„æ­£ç¡®æ€§ã€= the notion of <em>semantics preservation</em> (in terms of observable behaviours)
  S  = <code class="language-plaintext highlighter-rouge">e</code>
  C  = <code class="language-plaintext highlighter-rouge">s_compile e</code>
B(S) = <code class="language-plaintext highlighter-rouge">aeval st e</code> 
B(C) = functional <code class="language-plaintext highlighter-rouge">s_execute</code> 
     | relational <code class="language-plaintext highlighter-rouge">stack_multistep</code></p>
</blockquote>

<p>ä¹‹å‰æˆ‘ä»¬è¯æ˜è¿‡ <em>functional/computational</em> <code class="language-plaintext highlighter-rouge">Fixpoint</code> çš„æ€§è´¨</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">s_compile_correct</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">st</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">state</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">aexp</span><span class="o">),</span><span class="w">
  </span><span class="no">s_execute</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="o">(</span><span class="no">s_compile</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="no">aeval</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">].</span><span class="w">

</span><span class="c">(** é‡è¦çš„æ˜¯è¿™ä¸ªæ›´ä¸€èˆ¬çš„ã€Œæè¿°äº† prog å¦‚ä½•ä¸ stack äº¤äº’ã€çš„å®šç† **)</span><span class="w">
</span><span class="k">Theorem</span><span class="w"> </span><span class="no">s_execute_theorem</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">st</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">state</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">aexp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">stack</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">nat</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">prog</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">sinstr</span><span class="o">),</span><span class="w">
    </span><span class="no">s_execute</span><span class="w"> </span><span class="no">st</span><span class="w">                  </span><span class="no">stack</span><span class="w">  </span><span class="o">(</span><span class="no">s_compile</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="no">prog</span><span class="o">)</span><span class="w"> 
  </span><span class="o">=</span><span class="w"> </span><span class="no">s_execute</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">((</span><span class="no">aeval</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">stack</span><span class="o">)</span><span class="w">                 </span><span class="no">prog</span><span class="pi">.</span><span class="w">

</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨åˆ™æ˜¯è¯æ˜ <em>relational</em> <code class="language-plaintext highlighter-rouge">Inductive</code> çš„æ€§è´¨ï¼ŒåŒæ ·æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´ä¸€èˆ¬çš„å®šç†ï¼ˆç„¶ååŸå‘½é¢˜ä½œä¸ºæ¨è®ºï¼‰</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">stack_step_theorem</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">st</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">state</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">aexp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">stack</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">nat</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">prog</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">sinstr</span><span class="o">),</span><span class="w">
  </span><span class="no">stack_multistep</span><span class="w"> </span><span class="no">st</span><span class="w">
                  </span><span class="o">((</span><span class="no">s_compile</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="no">prog</span><span class="o">),</span><span class="w">                 </span><span class="no">stack</span><span class="o">)</span><span class="w"> 
                  </span><span class="o">(</span><span class="w">                </span><span class="no">prog</span><span class="w"> </span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">aeval</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">stack</span><span class="o">).</span><span class="w">      </span><span class="c">(** è¿™é‡Œ prog å’Œ stack çš„äº¤äº’æœ¬è´¨ä¸Šå’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ **)</span><span class="w">
</span><span class="k">Proof</span><span class="pi">.</span><span class="w">
  </span><span class="kp">unfold</span><span class="w"> </span><span class="no">stack_multistep</span><span class="pi">.</span><span class="w">
  </span><span class="kp">induction</span><span class="w"> </span><span class="no">e</span><span class="p">;</span><span class="w"> </span><span class="kp">intros</span><span class="p">;</span><span class="w"> </span><span class="kp">simpl</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="o">*</span><span class="p">;</span><span class="w">        </span><span class="c">(** è¯æ˜ induction on aexpï¼Œç„¶ååˆ©ç”¨ transivitiyã€constructor ä¸ IH å³å¯ï¼Œéå¸¸å¿« **)</span><span class="w">
    </span><span class="kp">try</span><span class="w"> </span><span class="o">(</span><span class="kp">apply</span><span class="w"> </span><span class="no">multi_R</span><span class="p">;</span><span class="w"> </span><span class="kp">constructor</span><span class="o">)</span><span class="p">;</span><span class="w">
    </span><span class="kp">try</span><span class="w"> </span><span class="o">(</span><span class="w">
        </span><span class="kp">repeat</span><span class="w"> </span><span class="o">(</span><span class="kp">rewrite</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">app_assoc</span><span class="o">)</span><span class="p">;</span><span class="w">
        </span><span class="kp">eapply</span><span class="w"> </span><span class="no">multi_trans</span><span class="p">;</span><span class="w"> </span><span class="kp">try</span><span class="w"> </span><span class="kp">apply</span><span class="w"> </span><span class="no">IHe1</span><span class="p">;</span><span class="w">
        </span><span class="kp">eapply</span><span class="w"> </span><span class="no">multi_trans</span><span class="p">;</span><span class="w"> </span><span class="kp">try</span><span class="w"> </span><span class="kp">apply</span><span class="w"> </span><span class="no">IHe2</span><span class="p">;</span><span class="w">
        </span><span class="kp">eapply</span><span class="w"> </span><span class="no">multi_R</span><span class="p">;</span><span class="w"> </span><span class="kp">constructor</span><span class="w">
      </span><span class="o">).</span><span class="w">
      
</span><span class="k">Definition</span><span class="w"> </span><span class="no">compiler_is_correct_statement</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">st</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">state</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">aexp</span><span class="o">),</span><span class="w">
  </span><span class="no">stack_multistep</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="o">(</span><span class="no">s_compile</span><span class="w"> </span><span class="no">e</span><span class="o">,</span><span class="w"> </span><span class="o">[])</span><span class="w"> </span><span class="o">([],</span><span class="w"> </span><span class="o">[</span><span class="no">aeval</span><span class="w"> </span><span class="no">st</span><span class="w"> </span><span class="no">e</span><span class="o">]).</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="aside-a-normalize-tactic">Aside: A <code class="language-plaintext highlighter-rouge">normalize</code> Tactic</h2>

<p>Even with <code class="language-plaintext highlighter-rouge">eapply</code> and <code class="language-plaintext highlighter-rouge">auto</code>â€¦manual normalization is tedious:</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">Example</span><span class="w"> </span><span class="no">step_example1'</span><span class="w"> </span><span class="p">:</span><span class="w">
  </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">4</span><span class="o">)))</span><span class="w">
  </span><span class="o">--&gt;*</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">10</span><span class="o">).</span><span class="w">
</span><span class="k">Proof</span><span class="pi">.</span><span class="w">
  </span><span class="kp">eapply</span><span class="w"> </span><span class="no">multi_step</span><span class="pi">.</span><span class="w"> </span><span class="kp">auto</span><span class="pi">.</span><span class="w"> </span><span class="kp">simpl</span><span class="pi">.</span><span class="w">
  </span><span class="kp">eapply</span><span class="w"> </span><span class="no">multi_step</span><span class="pi">.</span><span class="w"> </span><span class="kp">auto</span><span class="pi">.</span><span class="w"> </span><span class="kp">simpl</span><span class="pi">.</span><span class="w">
  </span><span class="kp">apply</span><span class="w"> </span><span class="no">multi_refl</span><span class="pi">.</span><span class="w">
</span><span class="k">Qed</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>We could write custom <code class="language-plaintext highlighter-rouge">Tactic Notation</code>â€¦(i.e. tactic macros)</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="no">Tactic</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="s2">"print_goal"</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">goal</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="p">âŠ¢</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="p">â‡’</span><span class="w"> </span><span class="no">idtac</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
  
</span><span class="no">Tactic</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="s2">"normalize"</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kp">repeat</span><span class="w"> </span><span class="o">(</span><span class="no">print_goal</span><span class="p">;</span><span class="w"> </span><span class="kp">eapply</span><span class="w"> </span><span class="no">multi_step</span><span class="w"> </span><span class="p">;</span><span class="w">
            </span><span class="o">[</span><span class="w"> </span><span class="o">(</span><span class="kp">eauto</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="no">fail</span><span class="o">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="kp">instantiate</span><span class="p">;</span><span class="w"> </span><span class="kp">simpl</span><span class="o">)])</span><span class="p">;</span><span class="w">
  </span><span class="kp">apply</span><span class="w"> </span><span class="no">multi_refl</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">instantiate</code> seems here for intros <code class="language-plaintext highlighter-rouge">âˆƒ</code>?</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">Example</span><span class="w"> </span><span class="no">step_example1'''</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">e'</span><span class="o">,</span><span class="w">
  </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">C</span><span class="w"> </span><span class="mi">4</span><span class="o">)))</span><span class="w">
  </span><span class="o">--&gt;*</span><span class="w"> </span><span class="no">e'</span><span class="pi">.</span><span class="w">
</span><span class="k">Proof</span><span class="pi">.</span><span class="w">
  </span><span class="kp">eapply</span><span class="w"> </span><span class="no">ex_intro</span><span class="pi">.</span><span class="w"> </span><span class="no">normalize</span><span class="pi">.</span><span class="w">
</span><span class="k">Qed</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>But what surprise me is that we can <code class="language-plaintext highlighter-rouge">eapply ex_intro</code>, which leave the <code class="language-plaintext highlighter-rouge">âˆƒ</code> as a hole <code class="language-plaintext highlighter-rouge">?ex</code> (unification variable).</p>
:ET